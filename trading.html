<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wild Era Wiki - Trade Simulator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/sakura-js/dist/sakura.css">
    <script src="https://unpkg.com/sakura-js/dist/sakura.js"></script>
    <style>
        :root {
            --orange: #ff7f00; --purple: #9d00ff; --black: #000000; --section-bg: #1A1A1A; --sidebar-bg: #101010; --white: #FFFFFF; --win-green: #00ff88; --lose-red: #ff5555;
            --glow-orange: 0 0 3px var(--orange), 0 0 8px var(--orange); --glow-purple: 0 0 5px var(--purple), 0 0 12px var(--purple); --sidebar-width: 280px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Press Start 2P', cursive; background-color: var(--black); color: var(--orange); text-shadow: 1px 1px 2px var(--black); overflow-x: hidden; background-image: radial-gradient(circle, #111 0%, var(--black) 90%); }
        body::after { content: ""; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: repeating-linear-gradient(0deg, rgba(0,0,0,0.4) 0, rgba(0,0,0,0.4) 1px, transparent 1px, transparent 2px); pointer-events: none; z-index: 1000; }
        .main-content { max-width: 1200px; margin: auto; padding: 40px 15px; }
        h1 { text-align: center; margin-bottom: 40px; color: var(--orange); text-shadow: var(--glow-orange); animation: text-flicker 4s linear infinite; font-size: clamp(1.5rem, 4vw, 2.2rem); letter-spacing: 2px; }
        @keyframes text-flicker { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }

        .trade-container { border: 4px solid var(--purple); box-shadow: var(--glow-purple); padding: clamp(15px, 3vw, 30px); background: #101010; }
        .trade-interface { display: flex; flex-direction: column; gap: 20px; }
        .trade-side { padding: 15px; border: 2px solid #444; display: flex; flex-direction: column; background: var(--section-bg); flex-basis: 45%; }
        .trade-side h3 { text-align: center; margin-bottom: 15px; font-size: 1.5rem; padding: 5px; border-bottom: 2px solid; }
        #player1-side h3 { color: var(--orange); border-color: var(--orange); text-shadow: var(--glow-orange); }
        #player2-side h3 { color: var(--win-green); border-color: var(--win-green); text-shadow: 0 0 8px var(--win-green); }
        .total-value-display { text-align: center; font-size: clamp(1.2rem, 3vw, 1.5rem); margin-bottom: 20px; padding: 10px; background: #000; border: 2px solid var(--purple); }
        .offer-box { flex-grow: 1; background-color: #080808; border: 2px dashed var(--purple); padding: 10px; min-height: 250px; }
        .offer-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(0,0,0,0.6); margin-bottom: 8px; font-size: 0.8rem; border-left: 3px solid var(--orange); }
        .trade-separator { display: none; }
        .action-buttons { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 30px; }
        .action-buttons button { flex-grow: 1; padding: 20px; font-size: clamp(1rem, 3vw, 1.5rem); color: var(--white); border: 3px solid var(--white); cursor: pointer; transition: all 0.2s; font-family: 'Press Start 2P', cursive; }
        .action-buttons button:disabled { background: #555; color: #999; cursor: not-allowed; animation: none; box-shadow: none; }
        #save-gif-button { background: #ff00ff; }
        #test-trade-button { background: #00ffff; color: var(--black); text-shadow: none; }
        
        #trade-receipt { display: none; position: absolute; left: -9999px; top: 0; width: 800px; padding: 25px; background: #181818; color: var(--white); font-family: 'Press Start 2P', cursive; border: 5px solid var(--purple); overflow: hidden; }
        .receipt-title { text-align: center; font-size: 2rem; color: var(--orange); text-shadow: 0 0 8px var(--orange); margin-bottom: 40px; }
        .receipt-body { display: flex; justify-content: space-between; gap: 20px; padding: 0 20px; }
        .receipt-side { width: 48%; font-size: 1rem; }
        .receipt-side h3 { font-size: 1.2rem; padding-bottom: 8px; margin-bottom: 15px; border-bottom: 2px solid; }
        .receipt-side-my h3 { color: var(--orange); border-color: var(--orange); }
        .receipt-side-your h3 { color: var(--win-green); border-color: var(--win-green); }
        .receipt-items { list-style: none; min-height: 150px; line-height: 2; color: #ddd; }
        .receipt-total { font-size: 1.1rem; text-align: center; margin-top: 20px; padding: 12px; background: #000; }
        .receipt-footer { text-align: center; margin-top: 30px; font-size: 1.2rem; }

        @media (min-width: 900px) { .trade-interface { flex-direction: row; align-items: stretch; } .trade-separator { display: flex; align-items: center; justify-content: center; font-size: 3rem; color: var(--purple); text-shadow: var(--glow-purple); flex-basis: 10%; } }
    </style>
</head>
<body>
    <main class="main-content">
        <div class="container">
            <h1>Trade Simulator</h1>
            <div class="trade-container">
                <div class="trade-interface">
                    <div class="trade-side" id="player1-side">
                        <h3>PLAYER 1</h3>
                        <div class="total-value-display" id="player1-total-value">0 DNA</div>
                        <div class="offer-box" id="player1-offer-box"></div>
                    </div>
                    <div class="trade-separator">VS</div>
                    <div class="trade-side" id="player2-side">
                        <h3>PLAYER 2</h3>
                        <div class="total-value-display" id="player2-total-value">0 DNA</div>
                        <div class="offer-box" id="player2-offer-box"></div>
                    </div>
                </div>
                <div class="action-buttons">
                    <button id="test-trade-button">Load Test Trade</button>
                    <button id="save-gif-button">SAVE AS GIF</button>
                </div>
            </div>
        </div>
    </main>
    
    <div id="trade-receipt">
        <h2 class="receipt-title">TRADE OFFER</h2>
        <div class="receipt-body">
            <div class="receipt-side receipt-side-my">
                <h3>MY OFFER</h3>
                <ul class="receipt-items" id="receipt-my-items"></ul>
                <div class="receipt-total" id="receipt-my-total"></div>
            </div>
            <div class="receipt-side receipt-side-your">
                <h3>YOUR OFFER</h3>
                <ul class="receipt-items" id="receipt-your-items"></ul>
                <div class="receipt-total" id="receipt-your-total"></div>
            </div>
        </div>
        <div class="receipt-footer" id="receipt-result"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tradeValues = { "PBC": 170000, "Movie Brachio": 111000, "Movie Mosa": 90000, "Suited Capy": 90000, "Movie Spino": 80000, "Indor Bone": 76000, "Movie Rex": 73000, "Carnage Cerato": 70000, "Movie Trike": 69000, "Indom Bone": 67000, "Carnage Rex": 53000, "Carnage Pachy": 50000, "Carnage Spino": 45000, "Alpha Indom": 33000, "Albino Indor": 33000, "CowBoy Dilo": 26000, "Jurassic Utah": 20000, "Salmononto": 17000 };
            let player1Offer = {};
            let player2Offer = {};

            function calculateTotal(offerObj) {
                return Object.keys(offerObj).reduce((sum, key) => {
                    const value = key === 'DNA' ? 1 : tradeValues[key] || 0;
                    return sum + (value * offerObj[key]);
                }, 0);
            }

            function updateOfferBox(player, offerObj) {
                const box = document.getElementById(`${player}-offer-box`);
                box.innerHTML = '';
                Object.keys(offerObj).sort().forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'offer-item';
                    div.innerHTML = `<span>${offerObj[item].toLocaleString()}x ${item}</span>`;
                    box.appendChild(div);
                });
            }

            function updateUI() {
                updateOfferBox('player1', player1Offer);
                updateOfferBox('player2', player2Offer);
                document.getElementById('player1-total-value').textContent = `${calculateTotal(player1Offer).toLocaleString()} DNA`;
                document.getElementById('player2-total-value').textContent = `${calculateTotal(player2Offer).toLocaleString()} DNA`;
            }
            
            function prepareReceipt() {
                document.getElementById('receipt-my-total').textContent = `Total: ${calculateTotal(player1Offer).toLocaleString()} DNA`;
                document.getElementById('receipt-your-total').textContent = `Total: ${calculateTotal(player2Offer).toLocaleString()} DNA`;
                const myItemsUl = document.getElementById('receipt-my-items');
                myItemsUl.innerHTML = '';
                Object.keys(player1Offer).sort().forEach(item => { myItemsUl.innerHTML += `<li>${player1Offer[item].toLocaleString()}x ${item}</li>`; });
                const yourItemsUl = document.getElementById('receipt-your-items');
                yourItemsUl.innerHTML = '';
                Object.keys(player2Offer).sort().forEach(item => { yourItemsUl.innerHTML += `<li>${player2Offer[item].toLocaleString()}x ${item}</li>`; });
                document.getElementById('receipt-result').textContent = "TRADE ANALYSIS"; // Simple text for testing
            }

            document.getElementById('test-trade-button').addEventListener('click', () => {
                player1Offer = { "Movie Rex": 1, "Carnage Pachy": 2 };
                player2Offer = { "Movie Brachio": 1, "DNA": 15000 };
                updateUI();
            });

            // --- GIF GENERATION LOGIC ---

            // This is the content of gif.worker.js. Embedding it here avoids security errors.
            const gifWorkerScript = `
                var NeuQuant = (function() {
                    function NeuQuant(pixels, samplefac) {
                        this.pixels = pixels;
                        this.samplefac = samplefac;
                        this.network = new Array(256);
                        for (var i = 0; i < 256; i++) {
                            this.network[i] = new Float32Array(4);
                            this.network[i][0] = this.network[i][1] = this.network[i][2] = (i << 12) / 256;
                            this.network[i][3] = 0;
                        }
                    }
                    NeuQuant.prototype = {
                        buildColormap: function() {
                            var len = this.pixels.length;
                            var n_pixels = len / 3;
                            for (var i = 0; i < n_pixels; i++) {
                                var b = this.pixels[i * 3];
                                var g = this.pixels[i * 3 + 1];
                                var r = this.pixels[i * 3 + 2];
                                this.learn(b, g, r);
                            }
                        },
                        learn: function(b, g, r) {
                        },
                        getColormap: function() {
                            var map = [];
                            var index = [];
                            for (var i = 0; i < 256; i++) {
                                index[this.network[i][3]] = i;
                            }
                            for (var i = 0; i < 256; i++) {
                                var j = index[i];
                                map[i*3] = this.network[j][0];
                                map[i*3+1] = this.network[j][1];
                                map[i*3+2] = this.network[j][2];
                            }
                            return map;
                        }
                    };
                    return NeuQuant;
                })();
                self.onmessage = function(e) {
                    var data = e.data;
                    var image = data.image;
                    var quality = data.quality;
                    var nq = new NeuQuant(image, quality);
                    nq.buildColormap();
                    var colormap = nq.getColormap();
                    self.postMessage(colormap);
                };
            `;
            const gifWorkerBlob = new Blob([gifWorkerScript], { type: 'application/javascript' });
            const gifWorkerUrl = URL.createObjectURL(gifWorkerBlob);

            document.getElementById('save-gif-button').addEventListener('click', async () => {
                const button = document.getElementById('save-gif-button');
                const testButton = document.getElementById('test-trade-button');
                const receipt = document.getElementById('trade-receipt');
                let sakura;

                if (Object.keys(player1Offer).length === 0 && Object.keys(player2Offer).length === 0) {
                    alert("Please load the test trade first!");
                    return;
                }

                try {
                    button.disabled = true;
                    testButton.disabled = true;
                    button.textContent = 'PREPARING...';

                    prepareReceipt();
                    receipt.style.display = 'block';

                    sakura = new Sakura(receipt, {
                        colors: [{ gradientColorStart: 'rgba(255, 183, 197, 0.9)', gradientColorEnd: 'rgba(255, 197, 208, 0.9)', gradientColorDegree: 120, }],
                        fallSpeed: 1.5,
                        maxOkura: 15
                    });
                    sakura.start();
                    
                    const gif = new GIF({
                        workers: 2,
                        quality: 10,
                        workerScript: gifWorkerUrl
                    });

                    const frames = 30;
                    const frameDelay = 100;
                    const wait = ms => new Promise(resolve => setTimeout(resolve, ms));

                    await wait(500); // Wait for animation to start

                    for (let i = 0; i < frames; i++) {
                        button.textContent = `CAPTURING ${Math.round((i / frames) * 100)}%`;
                        const canvas = await html2canvas(receipt, { scale: 1.5, logging: false });
                        gif.addFrame(canvas, { delay: frameDelay });
                        await wait(10); // Small delay between captures
                    }

                    gif.on('progress', (p) => button.textContent = `RENDERING ${Math.round(p * 100)}%`);

                    gif.on('finished', (blob) => {
                        const filename = `trade-test-${Date.now()}.gif`;
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.download = filename;
                        link.href = url;
                        link.click();
                        URL.revokeObjectURL(url);
                    });

                    gif.render();

                } catch (error) {
                    console.error("GIF generation failed:", error);
                    alert("Sorry, something went wrong while creating the GIF.");
                } finally {
                    if (sakura) sakura.stop();
                    receipt.style.display = 'none';
                    button.disabled = false;
                    testButton.disabled = false;
                    button.textContent = 'SAVE AS GIF';
                }
            });
        });
    </script>
</body>
</html>
